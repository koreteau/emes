cortocolloc@mac database % psql -U koreteau -d capaci
psql (14.15 (Homebrew))
Type "help" for help.

capaci=> CREATE TABLE Accounts (
    account_id VARCHAR(50) PRIMARY KEY,
    account_name VARCHAR(100) NOT NULL,
    account_type VARCHAR(50) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    entity_id VARCHAR(50) REFERENCES Entities(entity_id)
);
ERROR:  relation "entities" does not exist
capaci=> CREATE TABLE Entities (
    entity_id VARCHAR(50) PRIMARY KEY,
    entity_name VARCHAR(100) NOT NULL,
    entity_type VARCHAR(50) NOT NULL
);
CREATE TABLE
capaci=> CREATE TABLE Accounts (
    account_id VARCHAR(50) PRIMARY KEY,
    account_name VARCHAR(100) NOT NULL,
    account_type VARCHAR(50) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    entity_id VARCHAR(50) REFERENCES Entities(entity_id)
);
CREATE TABLE
capaci=> CREATE TABLE ProfitCenters (
    profit_center_id VARCHAR(50) PRIMARY KEY,
    profit_center_name VARCHAR(100) NOT NULL,
    parent_profit_center_id VARCHAR(50) REFERENCES ProfitCenters(profit_center_id)
);
CREATE TABLE
capaci=> CREATE TABLE CostCenters (
    cost_center_id VARCHAR(50) PRIMARY KEY,
    cost_center_name VARCHAR(100) NOT NULL,
    parent_cost_center_id VARCHAR(50) REFERENCES CostCenters(cost_center_id)
);
CREATE TABLE
capaci=> CREATE TABLE Scenarios (
    scenario_id VARCHAR(50) PRIMARY KEY,
    scenario_name VARCHAR(50) NOT NULL,
    description TEXT
);
CREATE TABLE
capaci=> CREATE TABLE Periods (
    period_id VARCHAR(50) PRIMARY KEY,
    year INTEGER NOT NULL,
    month INTEGER NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL
);
CREATE TABLE
capaci=> CREATE TABLE ExchangeRates (
    exchange_rate_id VARCHAR(50) PRIMARY KEY,
    from_currency VARCHAR(3) NOT NULL,
    to_currency VARCHAR(3) NOT NULL,
    rate NUMERIC NOT NULL,
    effective_date DATE NOT NULL,
    UNIQUE (from_currency, to_currency, effective_date)
);
CREATE TABLE
capaci=> CREATE TABLE Transactions (
    transaction_id VARCHAR(50) PRIMARY KEY,
    transaction_date DATE NOT NULL,
    amount NUMERIC NOT NULL,
    currency VARCHAR(3) NOT NULL,
    description TEXT,
    account_id VARCHAR(50) REFERENCES Accounts(account_id),
    profit_center_id VARCHAR(50) REFERENCES ProfitCenters(profit_center_id),
    cost_center_id VARCHAR(50) REFERENCES CostCenters(cost_center_id),
    entity_id VARCHAR(50) REFERENCES Entities(entity_id),
    scenario_id VARCHAR(50) REFERENCES Scenarios(scenario_id),
    period_id VARCHAR(50) REFERENCES Periods(period_id),
    exchange_rate NU
capaci(> 
capaci(> 
capaci(> \q
cortocolloc@mac database % psql -U koreteau -d capaci
psql (14.15 (Homebrew))
Type "help" for help.

capaci=> CREATE TABLE Transactions (
    transaction_id VARCHAR(50) PRIMARY KEY,
    transaction_date DATE NOT NULL,
    amount NUMERIC NOT NULL,
    currency VARCHAR(3) NOT NULL,
    description TEXT,
    account_id VARCHAR(50) REFERENCES Accounts(account_id),
    profit_center_id VARCHAR(50) REFERENCES ProfitCenters(profit_center_id),
    cost_center_id VARCHAR(50) REFERENCES CostCenters(cost_center_id),
    entity_id VARCHAR(50) REFERENCES Entities(entity_id),
    scenario_id VARCHAR(50) REFERENCES Scenarios(scenario_id),
    period_id VARCHAR(50) REFERENCES Periods(period_id),
    exchange_rate NUMERIC,
    amount_in_base_currency NUMERIC NOT NULL
);
CREATE TABLE
capaci=> CREATE TABLE Discrepancies (
    discrepancy_id VARCHAR(50) PRIMARY KEY,
    related_id VARCHAR(50) NOT NULL,
    related_type VARCHAR(20) NOT NULL CHECK (related_type IN ('Transaction', 'Invoice')),
    amount_difference NUMERIC NOT NULL,
    justification TEXT,
    resolved BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE
capaci=> CREATE TABLE InterCosts (
    ic_id VARCHAR(50) PRIMARY KEY,
    origin_cost_center_id VARCHAR(50) REFERENCES CostCenters(cost_center_id),
    destination_entity_id VARCHAR(50) REFERENCES Entities(entity_id),
    amount NUMERIC NOT NULL,
    currency VARCHAR(3) NOT NULL,
    transaction_date DATE NOT NULL,
    description TEXT
);
CREATE TABLE
capaci=> \dt
             List of relations
 Schema |     Name      | Type  |  Owner   
--------+---------------+-------+----------
 public | accounts      | table | koreteau
 public | costcenters   | table | koreteau
 public | discrepancies | table | koreteau
 public | entities      | table | koreteau
 public | exchangerates | table | koreteau
 public | intercosts    | table | koreteau
 public | periods       | table | koreteau
 public | profitcenters | table | koreteau
 public | scenarios     | table | koreteau
 public | transactions  | table | koreteau
(10 rows)

capaci=> \q
cortocolloc@mac database % psql -U koreteau -d capaci
psql (14.15 (Homebrew))
Type "help" for help.

capaci=> \dt
Did not find any relations.
capaci=> CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION
capaci=> CREATE TABLE Entities (
    entity_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    entity_name VARCHAR(100) NOT NULL,
    entity_type VARCHAR(50) NOT NULL
);
CREATE TABLE
capaci=> CREATE TABLE Accounts (
    account_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    account_name VARCHAR(100) NOT NULL,
    account_type VARCHAR(50) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    entity_id UUID REFERENCES Entities(entity_id),
    iban VARCHAR(34) NOT NULL UNIQUE
);
CREATE TABLE
capaci=> CREATE TABLE ProfitCenters (
    profit_center_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    profit_center_name VARCHAR(100) NOT NULL,
    parent_profit_center_id UUID REFERENCES ProfitCenters(profit_center_id)
);
CREATE TABLE
capaci=> CREATE TABLE CostCenters (
    cost_center_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    cost_center_name VARCHAR(100) NOT NULL,
    parent_cost_center_id UUID REFERENCES CostCenters(cost_center_id)
);
CREATE TABLE
capaci=> CREATE TABLE Scenarios (
    scenario_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    scenario_name VARCHAR(50) NOT NULL,
    description TEXT
);
CREATE TABLE
capaci=> CREATE TABLE Periods (
    period_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    year INTEGER NOT NULL,
    month INTEGER NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL
);
CREATE TABLE
capaci=> CREATE TABLE ExchangeRates (
    exchange_rate_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    from_currency VARCHAR(3) NOT NULL,
    to_currency VARCHAR(3) NOT NULL,
    rate NUMERIC NOT NULL,
    effective_date DATE NOT NULL,
    UNIQUE (from_currency, to_currency, effective_date)
);
CREATE TABLE
capaci=> CREATE TABLE Transactions (
    transaction_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    transaction_date DATE NOT NULL,
    amount NUMERIC NOT NULL,
    currency VARCHAR(3) NOT NULL,
    description TEXT,
    account_id UUID REFERENCES Accounts(account_id),
    profit_center_id UUID REFERENCES ProfitCenters(profit_center_id),
    cost_center_id UUID REFERENCES CostCenters(cost_center_id),
    entity_id UUID REFERENCES Entities(entity_id),
    scenario_id UUID REFERENCES Scenarios(scenario_id),
    period_id UUID REFERENCES Periods(period_id),
    exchange_rate NUMERIC,
    amount_in_base_currency NUMERIC NOT NULL
);
CREATE TABLE
capaci=> CREATE TABLE Discrepancies (
    discrepancy_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    related_id UUID NOT NULL,
    related_type VARCHAR(20) NOT NULL CHECK (related_type IN ('Transaction', 'Invoice')),
    amount_difference NUMERIC NOT NULL,
    justification TEXT,
    resolved BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE TABLE
capaci=> CREATE TABLE InterCosts (
    ic_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    origin_cost_center_id UUID REFERENCES CostCenters(cost_center_id),
    destination_entity_id UUID REFERENCES Entities(entity_id),
    amount NUMERIC NOT NULL,
    currency VARCHAR(3) NOT NULL,
    transaction_date DATE NOT NULL,
    description TEXT
);
CREATE TABLE
capaci=> ALTER TABLE Accounts
ADD COLUMN iban VARCHAR(34) NOT NULL UNIQUE;
ALTER TABLE
capaci=> CREATE INDEX idx_transactions_account ON Transactions (account_id);
CREATE INDEX
capaci=> CREATE INDEX idx_intercosts_origin ON InterCosts (origin_cost_center_id);
CREATE INDEX
capaci=> INSERT INTO Accounts (account_name, account_type, currency, iban, entity_id)
VALUES ('Compte Courant', 'Checking', 'EUR', 'FR7630006000011234567890189', 'uuid-of-entity');
ERROR:  invalid input syntax for type uuid: "uuid-of-entity"
LINE 2: ...'Checking', 'EUR', 'FR7630006000011234567890189', 'uuid-of-e...
                                                             ^
capaci=> INSERT INTO Entities (entity_name, entity_type)
VALUES ('My Business', 'Customer');
INSERT 0 1
capaci=> INSERT INTO Accounts (account_name, account_type, currency, iban, entity_id)
VALUES ('Compte Courant', 'Checking', 'EUR', 'FR7630006000011234567890189', 'uuid-of-entity');
ERROR:  invalid input syntax for type uuid: "uuid-of-entity"
LINE 2: ...'Checking', 'EUR', 'FR7630006000011234567890189', 'uuid-of-e...
                                                             ^
capaci=> SELECT * FROM Entities;
              entity_id               | entity_name | entity_type 
--------------------------------------+-------------+-------------
 227ea199-6859-4777-95a6-6f00414cb5b4 | My Business | Customer
(1 row)

capaci=> INSERT INTO Accounts (account_name, account_type, currency, iban, entity_id)
VALUES ('Compte Courant', 'Checking', 'EUR', 'FR7630006000011234567890189', '227ea199-6859-4777-95a6-6f00414cb5b4');
INSERT 0 1
capaci=> SELECT * FROM Accounts;
              account_id              |  account_name  | account_type | currency |              entity_id               |            iban             
--------------------------------------+----------------+--------------+----------+--------------------------------------+-----------------------------
 315baf6e-6cb6-4586-a613-984169295164 | Compte Courant | Checking     | EUR      | 227ea199-6859-4777-95a6-6f00414cb5b4 | FR7630006000011234567890189
(1 row)

capaci=> CREATE TABLE Users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(50) UNIQUE NOT NULL,
    password TEXT NOT NULL, -- Mot de passe hashé
    is_admin BOOLEAN DEFAULT FALSE, -- Si l'utilisateur est admin, il a accès à tout
    security_classes UUID[] -- Liste des Security Classes assignées à cet utilisateur
);
CREATE TABLE

CREATE TABLE SecurityClasses (
    security_class_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(100) NOT NULL,
    access_type VARCHAR(10) NOT NULL CHECK (access_type IN ('all', 'read', 'none')),
    entity_id UUID REFERENCES Entities(entity_id) ON DELETE CASCADE,
    account_id UUID REFERENCES Accounts(account_id) ON DELETE CASCADE,
    cost_center_id UUID REFERENCES CostCenters(cost_center_id) ON DELETE CASCADE,
    profit_center_id UUID REFERENCES ProfitCenters(profit_center_id) ON DELETE CASCADE,
    intercost_id UUID REFERENCES InterCosts(ic_id) ON DELETE CASCADE
);

CREATE TABLE CostCenters (
    cost_center_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    cost_center_name VARCHAR(100) NOT NULL,
    parent_cost_center_id UUID REFERENCES CostCenters(cost_center_id)
);

UPDATE Users
SET security_classes = ARRAY['1bddb812-1d3a-40e3-9b0c-bd8f68c4f330']
WHERE id = '4de2b0b5-5f8b-4431-bd63-19ba54aa805f';


ALTER TABLE Transactions
  RENAME TO Data;

ALTER TABLE Data
  RENAME COLUMN transaction_date TO data_date;

CREATE TABLE Transactions (
    transaction_id VARCHAR(50) PRIMARY KEY,
    transaction_date DATE NOT NULL,
    amount NUMERIC NOT NULL,
    currency VARCHAR(3) NOT NULL,
    description TEXT,
    account_id UUID REFERENCES Accounts(account_id),
    profit_center_id UUID REFERENCES ProfitCenters(profit_center_id),
    cost_center_id UUID REFERENCES CostCenters(cost_center_id)
);

CREATE TABLE Ownerships (
    ownership_id VARCHAR(50) PRIMARY KEY,
    percentage ... NOT NULL,
    description TEXT,
    account_id UUID REFERENCES Accounts(account_id),
    entity_id UUID REFERENCES Entities(entity_id)
);

INSERT INTO Accounts (account_name, account_type, currency, entity_id, iban)
VALUES ('H.U.B', 'checking', 'EUR', 'f1e2d3c4-5678-90ab-cdef-0987654321ab');

INSERT INTO Ownerships (percentage, description, account_id, entity_id)
VALUES ('100', 'Ownership description', '315baf6e-6cb6-4586-a613-984169295164', '94bd378f-746e-4b1b-b460-e6ff4a503b56');

ALTER TABLE Ownerships
  RENAME COLUMN entity_id TO subsidiary_entity_id;

INSERT INTO Ownerships (from_currency, description, account_id, entity_id)
VALUES ('100', 'Ownership description', '315baf6e-6cb6-4586-a613-984169295164', '94bd378f-746e-4b1b-b460-e6ff4a503b56');


ALTER TABLE accounts 
    DROP COLUMN flow_ope,
    DROP COLUMN flow_cho,
    DROP COLUMN flow_ini,
    DROP COLUMN flow_inc,
    DROP COLUMN flow_dec,
    DROP COLUMN flow_dcp,
    DROP COLUMN flow_dco,
    DROP COLUMN flow_dcm,
    DROP COLUMN flow_cti,
    DROP COLUMN flow_riv,
    DROP COLUMN flow_dev,
    DROP COLUMN flow_cwc,
    DROP COLUMN flow_cai;
    

ALTER TABLE accounts
    DROP COLUMN flow_cad,
    DROP COLUMN flow_mrg,
    DROP COLUMN flow_sin,
    DROP COLUMN flow_sou,
    DROP COLUMN flow_sva,
    DROP COLUMN flow_rec,
    DROP COLUMN flow_act,
    DROP COLUMN flow_app,
    DROP COLUMN flow_nin,
    DROP COLUMN flow_div,
    DROP COLUMN flow_varpl,
    DROP COLUMN flow_vareq,
    DROP COLUMN flow_ctrpl,
    DROP COLUMN flow_ctreq,
    DROP COLUMN flow_rel,
    DROP COLUMN flow_mkv,
    DROP COLUMN flow_le1,
    DROP COLUMN flow_chk,
    DROP COLUMN flow_clo;


INSERT INTO accounts (internal_id, account_name, account_type, currency, dimension_scenario, dimension_year, dimension_period, dimension_entity, flow_ope, flow_cho, flow_ini, flow_inc, flow_dec, flow_dcp, flow_dco, flow_dcm, flow_cti, flow_riv, flow_dev, flow_cwc, flow_cai, flow_cad, flow_mrg, flow_sin, flow_sou, flow_sva, flow_rec, flow_act, flow_app, flow_nin, flow_div, flow_varpl, flow_vareq, flow_ctrpl, flow_ctreq, flow_rel, flow_mkv, flow_le1, flow_chk, flow_clo) VALUES ('BS512000', 'Main Bank Account', 'BS', 'EUR', '[None]', '[None]', '[None]', '[None]', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated');
INSERT INTO accounts (internal_id, account_name, account_type, currency, parent_account_id, dimension_scenario, dimension_year, dimension_period, dimension_entity, flow_ope, flow_cho, flow_ini, flow_inc, flow_dec, flow_dcp, flow_dco, flow_dcm, flow_cti, flow_riv, flow_dev, flow_cwc, flow_cai, flow_cad, flow_mrg, flow_sin, flow_sou, flow_sva, flow_rec, flow_act, flow_app, flow_nin, flow_div, flow_varpl, flow_vareq, flow_ctrpl, flow_ctreq, flow_rel, flow_mkv, flow_le1, flow_chk, flow_clo) VALUES ('BS512100', 'Caisse d Epargne Bank Account', 'Balance Sheet', 'EUR', '43068d5e-b4d7-4931-a8f7-b5124ff517af', '7f33d604-8e82-4956-8c57-362b7bd94754', '[None]', '[None]', '[None]', '[None]', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'closed', 'closed', 'invalid', 'calculated', 'calculated', 'closed', 'calculated', 'calculated', 'closed', 'calculated', 'calculated', 'closed', 'calculated', 'invalid', 'calculated', 'calculated', 'closed', 'calculated', 'calculated', 'calculated', 'closed', 'closed', 'calculated', 'calculated', 'closed', 'calculated', 'closed');
INSERT INTO accounts (internal_id, account_name, account_type, currency, parent_account_id, dimension_scenario, dimension_year, dimension_period, dimension_entity, flow_ope, flow_cho, flow_ini, flow_inc, flow_dec, flow_dcp, flow_dco, flow_dcm, flow_cti, flow_riv, flow_dev, flow_cwc, flow_cai, flow_cad, flow_mrg, flow_sin, flow_sou, flow_sva, flow_rec, flow_act, flow_app, flow_nin, flow_div, flow_varpl, flow_vareq, flow_ctrpl, flow_ctreq, flow_rel, flow_mkv, flow_le1, flow_chk, flow_clo) VALUES ('BS512200', 'Societe Genarale Bank Account', 'Balance Sheet', 'EUR', '43068d5e-b4d7-4931-a8f7-b5124ff517af', '7f33d604-8e82-4956-8c57-362b7bd94754', '[None]', '[None]', '[None]', '[None]', 'calculated', 'calculated', 'calculated', 'calculated', 'calculated', 'closed', 'closed', 'invalid', 'calculated', 'calculated', 'closed', 'calculated', 'calculated', 'closed', 'calculated', 'calculated', 'closed', 'calculated', 'invalid', 'calculated', 'calculated', 'closed', 'calculated', 'calculated', 'calculated', 'closed', 'closed', 'calculated', 'calculated', 'closed', 'calculated', 'closed');
INSERT INTO accounts (internal_id, account_name, account_type, currency, parent_account_id, dimension_scenario, dimension_year, dimension_period, dimension_entity, flow_ope, flow_cho, flow_ini, flow_inc, flow_dec, flow_dcp, flow_dco, flow_dcm, flow_cti, flow_riv, flow_dev, flow_cwc, flow_cai, flow_cad, flow_mrg, flow_sin, flow_sou, flow_sva, flow_rec, flow_act, flow_app, flow_nin, flow_div, flow_varpl, flow_vareq, flow_ctrpl, flow_ctreq, flow_rel, flow_mkv, flow_le1, flow_chk, flow_clo) VALUES ('BS512101', 'Account 047753104566', 'Balance Sheet', 'EUR', '77d1a1ec-6568-4d04-b6d4-781e90fa221c', '71ca10b6-bfe7-4134-84df-522c9c018e5e', '[None]', '[None]', '[None]', '[None]', 'calculated', 'open', 'calculated', 'open', 'open', 'closed', 'closed', 'invalid', 'calculated', 'open', 'closed', 'calculated', 'open', 'closed', 'calculated', 'open', 'closed', 'calculated', 'invalid', 'calculated', 'open', 'closed', 'open', 'calculated', 'calculated', 'closed', 'closed', 'open', 'calculated', 'closed', 'calculated', 'closed');
INSERT INTO accounts (internal_id, account_name, account_type, currency, parent_account_id, dimension_scenario, dimension_year, dimension_period, dimension_entity, flow_ope, flow_cho, flow_ini, flow_inc, flow_dec, flow_dcp, flow_dco, flow_dcm, flow_cti, flow_riv, flow_dev, flow_cwc, flow_cai, flow_cad, flow_mrg, flow_sin, flow_sou, flow_sva, flow_rec, flow_act, flow_app, flow_nin, flow_div, flow_varpl, flow_vareq, flow_ctrpl, flow_ctreq, flow_rel, flow_mkv, flow_le1, flow_chk, flow_clo) VALUES ('BS512201', 'Account 561280694434', 'Balance Sheet', 'EUR', '77d1a1ec-6568-4d04-b6d4-781e90fa221c', '6e98b856-b05a-4b5c-8603-9de9ed43dc6d', '[None]', '[None]', '[None]', '[None]', 'calculated', 'open', 'calculated', 'open', 'open', 'closed', 'closed', 'invalid', 'calculated', 'open', 'closed', 'calculated', 'open', 'closed', 'calculated', 'open', 'closed', 'calculated', 'invalid', 'calculated', 'open', 'closed', 'open', 'calculated', 'calculated', 'closed', 'closed', 'open', 'calculated', 'closed', 'calculated', 'closed');

[None]
'77d1a1ec-6568-4d04-b6d4-781e90fa221c'

ALTER TABLE accounts 
    ADD COLUMN flow_ope VARCHAR(10) NOT NULL,
    ADD COLUMN flow_cho VARCHAR(10) NOT NULL,
    ADD COLUMN flow_ini VARCHAR(10) NOT NULL,
    ADD COLUMN flow_inc VARCHAR(10) NOT NULL,
    ADD COLUMN flow_dec VARCHAR(10) NOT NULL,
    ADD COLUMN flow_dcp VARCHAR(10) NOT NULL,
    ADD COLUMN flow_dco VARCHAR(10) NOT NULL,
    ADD COLUMN flow_dcm VARCHAR(10) NOT NULL,
    ADD COLUMN flow_cti VARCHAR(10) NOT NULL,
    ADD COLUMN flow_riv VARCHAR(10) NOT NULL,
    ADD COLUMN flow_dev VARCHAR(10) NOT NULL,
    ADD COLUMN flow_cwc VARCHAR(10) NOT NULL,
    ADD COLUMN flow_cai VARCHAR(10) NOT NULL,
    ADD COLUMN flow_cad VARCHAR(10) NOT NULL,
    ADD COLUMN flow_mrg VARCHAR(10) NOT NULL;
    

ALTER TABLE accounts
    ADD COLUMN flow_sin VARCHAR(10) NOT NULL,
    ADD COLUMN flow_sou VARCHAR(10) NOT NULL,
    ADD COLUMN flow_sva VARCHAR(10) NOT NULL,
    ADD COLUMN flow_rec VARCHAR(10) NOT NULL,
    ADD COLUMN flow_act VARCHAR(10) NOT NULL,
    ADD COLUMN flow_app VARCHAR(10) NOT NULL,
    ADD COLUMN flow_nin VARCHAR(10) NOT NULL,
    ADD COLUMN flow_div VARCHAR(10) NOT NULL,
    ADD COLUMN flow_varpl VARCHAR(10) NOT NULL,
    ADD COLUMN flow_vareq VARCHAR(10) NOT NULL,
    ADD COLUMN flow_ctrpl VARCHAR(10) NOT NULL,
    ADD COLUMN flow_ctreq VARCHAR(10) NOT NULL,
    ADD COLUMN flow_rel VARCHAR(10) NOT NULL,
    ADD COLUMN flow_mkv VARCHAR(10) NOT NULL,
    ADD COLUMN flow_le1 VARCHAR(10) NOT NULL,
    ADD COLUMN flow_chk VARCHAR(10) NOT NULL,
    ADD COLUMN flow_clo VARCHAR(10) NOT NULL;

ALTER TABLE accounts
    DROP COLUMN entity_id;

ALTER TABLE accounts
    ADD COLUMN dimension_scenario TEXT NOT NULL,
    ADD COLUMN dimension_year TEXT NOT NULL,
    ADD COLUMN dimension_period TEXT NOT NULL,
    ADD COLUMN dimension_entity TEXT NOT NULL;



ALTER TABLE webforms ADD COLUMN parent TEXT NOT NULL,

INSERT INTO webforms (name, path, parent, security_group) VALUES ('ExchangeRates', 'webform_003.json', '', 'ALLUSER');




CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name TEXT NOT NULL,
    type TEXT NOT NULL,
    path TEXT,
    parent_id UUID REFERENCES documents(id) ON DELETE CASCADE,
    security_classes TEXT NOT NULL DEFAULT 'public',
    created_at TIMESTAMP DEFAULT NOW()
);



INSERT INTO documents (name, type, path, parent_id, security_classes) VALUES ('1. Reports', 'folder', NULL, NULL, 'public');
INSERT INTO documents (name, type, path, parent_id, security_classes) VALUES ('Annual Report', 'report', 'report_001.json', '4c903ddb-ea7d-4ec1-933a-53b6e959ca63', 'public');
INSERT INTO documents (name, type, path, parent_id, security_classes) VALUES ('Exchange Rates', 'webform', 'webform_002.json', NULL, 'public');



CREATE TABLE journals (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    description TEXT,
    author TEXT,
    timestamp TIMESTAMPTZ DEFAULT NOW()
);

CREATE TABLE data (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    scenario TEXT NOT NULL,
    year TEXT NOT NULL,
    period TEXT NOT NULL,
    entity TEXT NOT NULL,
    account TEXT NOT NULL,
    custom1 TEXT NOT NULL,
    custom2 TEXT NOT NULL,
    custom3 TEXT NOT NULL,
    custom4 TEXT NOT NULL,
    ICP TEXT NOT NULL,
    view TEXT NOT NULL,
    value TEXT NOT NULL,
    data_value TEXT NOT NULL,
    author TEXT,
    timestamp TIMESTAMPTZ DEFAULT NOW(),
    journal_id UUID REFERENCES journals(id) ON DELETE SET NULL
);

CREATE TABLE dimensionData (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    version TEXT NOT NULL,
    label TEXT,
    path TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by TEXT
);

INSERT INTO dimensionData (version, label, path, created_by) VALUES ('0.1.0', '', 'dimensionData_001', 'admin');

http://localhost:8080/api/dimensions/27c5775c-0df3-404d-a85b-4d1ca8db2617/content

UPDATE data SET data_value = '9999' WHERE id = 'bf4cb55e-6806-4a73-83c8-ceb2000c5abf';
UPDATE data SET scenario = 'ACT' WHERE id = 'ccda2da9-71e9-423b-a11b-45b7041e5812';


CREATE TABLE journals (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    label TEXT NOT NULL,
    status TEXT NOT NULL DEFAULT 'draft',
    author TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    posted_at TIMESTAMPTZ
);

CREATE TABLE journal_lines (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    journal_id UUID REFERENCES journals(id) ON DELETE CASCADE,
    scenario TEXT NOT NULL,
    year TEXT NOT NULL,
    period TEXT NOT NULL,
    entity TEXT NOT NULL,
    account TEXT NOT NULL,
    custom1 TEXT NOT NULL,
    custom2 TEXT NOT NULL,
    custom3 TEXT NOT NULL,
    custom4 TEXT NOT NULL,
    icp TEXT NOT NULL,
    view TEXT NOT NULL,
    value TEXT NOT NULL,
    amount NUMERIC NOT NULL,
    comment TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW()
);


ALTER TABLE journals
ADD COLUMN scenario TEXT NOT NULL,
ADD COLUMN year TEXT NOT NULL,
ADD COLUMN period TEXT NOT NULL,
ADD COLUMN entity TEXT NOT NULL,
ADD COLUMN view TEXT NOT NULL;


-- Plus besoin de scenario, year, period, entity, view dans journal_lines
ALTER TABLE journal_lines
DROP COLUMN scenario,
DROP COLUMN year,
DROP COLUMN period,
DROP COLUMN entity,
DROP COLUMN view;
DROP COLUMN value;

ALTER TABLE journals ADD COLUMN value TEXT NOT NULL;
ALTER TABLE journal_lines DROP COLUMN value;


CREATE TABLE staged_data (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    scenario TEXT NOT NULL,
    year TEXT NOT NULL,
    period TEXT NOT NULL,
    entity TEXT NOT NULL,
    account TEXT NOT NULL,
    custom1 TEXT NOT NULL,
    custom2 TEXT NOT NULL,
    custom3 TEXT NOT NULL,
    custom4 TEXT NOT NULL,
    icp TEXT NOT NULL,
    view TEXT NOT NULL,
    value TEXT NOT NULL,
    data_value TEXT NOT NULL,
    source TEXT NOT NULL,         -- journal_id, nom de fichier, id ERP...
    status TEXT,                  -- 'posted', 'validated', 'rejected', etc.
    author TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT now()
);

CREATE INDEX idx_staged_data_pov
ON staged_data (scenario, year, period, entity);

CREATE INDEX idx_data_pov
ON data (scenario, year, period, entity);

const pool = require('../config/db');

const DIMENSIONS_PATH = "../../database/config/dimensions.json"
const RULES_PATH = "../../database/config/rules.js"

tout est bon et sur le bon type ! Merci pour ton aide.
Maintenant j'aimerai qu'on parle des calculs et consolisations pour faire le chemin staged_data -> data


-- Cas 1 : CC1 uniquement dans staged_data => calcNeeded
INSERT INTO staged_data (
  scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, source, status, author
)
VALUES (
  'ACT', '2025', 'P01', 'CC1', 'PL', 'CHO', '[None]', 'CH01010101', 'WEEK1', '[None]', 'YTD', '<Entity Curr>', 100, 'manual', 'posted', 'admin'
);

-- Cas 2 : CC2 dans les deux avec même valeur => upToDate
INSERT INTO staged_data (
  scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, source, status, author
)
VALUES (
  'ACT', '2025', 'P01', 'CC2', 'PL', 'CHO', '[None]', 'CH01010102', 'WEEK1', '[None]', 'YTD', '<Entity Curr>', 200, 'manual', 'posted', 'admin'
);

INSERT INTO data (
  scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, author
)
VALUES (
  'ACT', '2025', 'P01', 'CC2', 'PL', 'CHO', '[None]', 'CH01010102', 'WEEK1', '[None]', 'YTD', 200, '200', 'admin'
);

-- Cas 3 : CC3 dans les deux avec valeur différente => calcNeeded
INSERT INTO staged_data (
  scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, source, status, author
)
VALUES (
  'ACT', '2025', 'P01', 'CC3', 'PL', 'CHO', '[None]', 'CH01010103', 'WEEK1', '[None]', 'YTD', '<Entity Curr>', 300, 'manual', 'posted', 'admin'
);

INSERT INTO data (
  scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, author
)
VALUES (
  'ACT', '2025', 'P01', 'CC3', 'PL', 'CHO', '[None]', 'CH01010103', 'WEEK1', '[None]', 'YTD', 310, '310', 'admin'
);

-- Cas 4 : CC4 sans données mais enfant CC2 ou CC3 a une valeur => consoNeeded
-- (Ce cas nécessite que CC4 soit parent de CC2 ou CC3 dans la hiérarchie !)
-- Assure-toi que dans ton fichier JSON de dimension, CC4 est parent de CC2 et/ou CC3.



INSERT INTO capaci_staged_data (
  scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, source, status, author
)
VALUES
  ('ACT', 2025, 'P01', 'CCUSD', 'PL', 'CHO', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', 75, 'manual', 'posted', 'admin'),
  ('ACT', 2025, 'P01', 'CCUSD', 'PL', 'CHO', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', 50, 'manual', 'posted', 'admin');


INSERT INTO capaci_staged_data (
  scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, source, status, author
)
VALUES
  ('ACT', 2025, 'P01', 'CCEUR', 'PL', 'CHO', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', -400, 'manual', 'posted', 'admin' );



INSERT INTO capaci_documents (
  name, type, path, parent_id, security_classes
)
VALUES
  ('SuiSuivi Value Fonction Raise Data', 'webform', 'webform_001', null, 'admin');


INSERT INTO capaci_data (
  scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, author
)
VALUES
  ('ACT', 2025, 'P01', 'CCEUR', 'PERCENTAGE', '[None]', '[None]', '[None]', '[None]', '[None]', '[None]', '[None]', 100, 'admin'),
  ('ACT', 2025, 'P01', 'CCGBP', 'PERCENTAGE', '[None]', '[None]', '[None]', '[None]', '[None]', '[None]', '[None]', 100, 'admin'),
  ('ACT', 2025, 'P01', 'CCUSD', 'PERCENTAGE', '[None]', '[None]', '[None]', '[None]', '[None]', '[None]', '[None]', 100, 'admin');

INSERT INTO capaci_data (
  scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, author
)
VALUES
  ('ACT', 2025, 'P01', 'CCEUR', 'ACTIVE', '[None]', '[None]', '[None]', '[None]', '[None]', '[None]', '[None]', 1, 'admin'),
  ('ACT', 2025, 'P01', 'CCGBP', 'ACTIVE', '[None]', '[None]', '[None]', '[None]', '[None]', '[None]', '[None]', 1, 'admin'),
  ('ACT', 2025, 'P01', 'CCUSD', 'ACTIVE', '[None]', '[None]', '[None]', '[None]', '[None]', '[None]', '[None]', 1, 'admin');


SELECT * FROM capaci_data WHERE scenario='ACT' AND year='2025' AND period='P01' AND entity='CCGBP' AND account='PERCENTAGE';
SELECT * FROM capaci_data WHERE scenario='ACT' AND year='2025' AND period='P01' AND entity='CCGBP' AND account='ACTIVE';
SELECT * FROM capaci_data WHERE account='CLOSING' AND custom2='EUR';
SELECT * FROM capaci_data WHERE account='AVERAGE' AND custom2='EUR';
SELECT * FROM capaci_data WHERE scenario='ACT' AND year='2025' AND period='P01' AND account='CLOSING' AND custom2='GBP';
SELECT * FROM capaci_data WHERE account='AVERAGE' AND custom2='GBP';
SELECT * FROM capaci_data WHERE account='CLOSING' AND custom2='USD';
SELECT * FROM capaci_data WHERE account='AVERAGE' AND custom2='USD';

UPDATE capaci_documents SET name = 'Suivi Value Fonction' WHERE id = '7dac7b6c-6c29-4a9e-afaa-69e6f41df3c1';

INSERT INTO capaci_documents (
  name, type, path, parent_id, security_classes
)
VALUES
  ('PL', 'folder', null, null, 'admin'),
  ('BS', 'folder', null, null, 'admin');

UPDATE capaci_documents SET name = '2. BS' WHERE id = '6ba6fd4a-43dc-4f91-9123-56e5de60aed8';
UPDATE capaci_documents SET name = '3. PL' WHERE id = '6ba6fd4a-43dc-4f91-9123-56e5de60aed8';


INSERT INTO capaci_documents (
  name, type, path, parent_id, security_classes
)
VALUES
  ('1. Equity and Liabilities', 'webform', 'webform_004', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin'),
  ('2. Fixed assets', 'webform', 'webform_005', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin'),
  ('3. Inventory and Work in progress', 'webform', 'webform_006', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin'),
  ('5. Financial Accounts', 'webform', 'webform_007', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin'),
  ('6. Losts', 'webform', 'webform_008', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin'),
  ('7. Profits', 'webform', 'webform_009', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin'),
  ('8. Special', 'webform', 'webform_010', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin');



// tests calculates signs accounts PL

INSERT INTO capaci_staged_data (
    scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, source, status, author
)
VALUES
('ACT', '2025', 'P01', 'CCEUR', 'LS60500S', 'CHO', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', 150, 'manual', 'posted', 'admin'),
('ACT', '2025', 'P01', 'CCEUR', 'EQ10680S', 'CHO', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', 300, 'manual', 'posted', 'admin'),
('ACT', '2025', 'P01', 'CCEUR', 'LS60225S', 'CHO', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', 75, 'manual', 'posted', 'admin');


INSERT INTO capaci_staged_data (
    scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, source, status, author
) VALUES
('ACT', '2025', 'P01', 'CCEUR', 'EQ10680S', 'INC', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', 1000, 'manual', 'posted', 'admin'),
('ACT', '2025', 'P01', 'CCEUR', 'EQ10680S', 'CHO', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', 200,  'manual', 'posted', 'admin'),
('ACT', '2025', 'P01', 'CCEUR', 'EQ12000S', 'DCP', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', -50,  'manual', 'posted', 'admin'),
('ACT', '2025', 'P01', 'CCEUR', 'EQ10680S', 'DCO', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', 25,   'manual', 'posted', 'admin'),
('ACT', '2025', 'P01', 'CCEUR', 'EQ12000S', 'DCM', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', 15,   'manual', 'posted', 'admin'),
('ACT', '2025', 'P01', 'CCEUR', 'EQ10680S', 'CTI', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', 10,   'manual', 'posted', 'admin'),
('ACT', '2025', 'P01', 'CCEUR', 'EQ10680S', 'MKV', '[None]', '[None]', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', 150,  'manual', 'posted', 'admin');


INSERT INTO capaci_staged_data (
    scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, source, status, author
) VALUES
('ACT', '2025', 'P01', 'CCEUR', 'SP89000S', 'CHO', '[None]', 'CH01010100', '[None]', '[None]', 'YTD', '<Entity Curr Adjs>', 2603.42, 'manual', 'posted', 'admin');


INSERT INTO capaci_data (
  scenario, year, period, entity, account, custom1, custom2, custom3, custom4, icp, view, value, data_value, author
)
VALUES
  ('ACT', 2025, 'P01', 'CCEUR', 'SP89000S', 'CHO', '[None]', 'CH01010100', '[None]', '[None]', 'YTD', '<Entity Currency>', 2603.42, 'admin'),
  ('ACT', 2025, 'P01', 'CCEUR', 'FA51210S', 'CHO', '[None]', 'CH01010100', '[None]', '[None]', 'YTD', '<Entity Currency>', -2603.42, 'admin');


INSERT INTO capaci_documents (
  name, type, path, parent_id, security_classes
)
VALUES
  ('2. Accounts', 'folder', null, null, 'admin');


INSERT INTO capaci_documents (
  name, type, path, parent_id, security_classes
)
VALUES
  ('1. Equity and Liabilities', 'webform', 'webform_004', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin'),
  ('2. Fixed assets', 'webform', 'webform_005', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin'),
  ('3. Inventory and Work in progress', 'webform', 'webform_006', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin'),
  ('5. Financial Accounts', 'webform', 'webform_007', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin'),
  ('6. Losts', 'webform', 'webform_008', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin'),
  ('7. Profits', 'webform', 'webform_009', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin'),
  ('8. Special', 'webform', 'webform_010', '6ba6fd4a-43dc-4f91-9123-56e5de60aed8', 'admin');